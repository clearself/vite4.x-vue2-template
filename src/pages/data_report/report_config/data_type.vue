<template>
    <div class="event event-wrapper data_type">
        <div class="ub ub-pj w100 mb-1">
            <div class="list-tips">报送数据类型</div>
        </div>
        <div>
            <el-table
                ref="multipleTable"
                v-loading="listLoading"
                class='bigTable'
                :data="tableData"
                border
                stripe
                tooltip-effect="dark"
                :row-class-name="tableRowClassName"
                @selection-change="handleSelectionChange"
                :height="tableHeight"
                :row-style="{ height: '32px' }"
                :header-row-style="{ height: '32px' }">
                <el-table-column align="center" type="index" width="50" label="序号" :index="indexMethod">
                </el-table-column>
                <el-table-column prop="code" label="报送数据类型编码" width="200" show-overflow-tooltip>
                </el-table-column>
                <el-table-column prop="name" label="报送数据类型" width="200" show-overflow-tooltip>
                </el-table-column>
                <el-table-column label="映射关系" show-overflow-tooltip>
                    <template slot-scope="scope">
                        <div>
                            <div style="display: inline;" v-for="(item,index) in scope.row.ruleItems" :key="index">
                                <span class="mapping-color">{{item.fieldCn}} {{item.symbolCn}} {{item.value}}</span>
                                <span class="mapping-or" v-if="index != scope.row.ruleItems.length-1&&!scope.row.isOr" style="margin: 0 10px;">or</span>
                            </div>
                        </div>
                    </template>
                </el-table-column>
                <el-table-column align="center" label="操作" width="100" fixed="right" class-name="deepBg">
                    <template slot-scope="scope">
                        <el-button type="text" size="small" title="编辑" @click="handleEdit(scope.row)">编辑</el-button>
                        <!-- <el-button type="text" size="small" title="删除" @click="handleDel(scope.row)">删除</el-button> -->
                    </template>
                </el-table-column>
            </el-table>
            <pagination v-show="total>0" :total="total" :page.sync="listQuery.page" :limit.sync="listQuery.limit" @pagination="get_data" />
        </div>
        <el-dialog title="编辑" width="700px" :visible.sync="addEditDialog" custom-class="attendance-dialog">
            <el-form ref="formData" :model="formData" :rules="rules">
                <el-form-item label="报送数据类型：" :label-width="formLabelWidth">
                    <el-input disabled size="small" clearable v-model.trim="formData.typeName"></el-input>
                </el-form-item>
                <el-form-item label="映射关系：" :label-width="formLabelWidth">
                    <div class="rule-area">
                        <div class="ub ub-ac w100">
                            <div v-if="formData.contentArr.length > 0" class="ub ub-pc ub-ac or-btn" style="width:30px;font-size:18px;">or</div>
                            <div class="ub ub-f1 ub-ver">
                                <div class="ub ub-f1 ub-pj mapping-item" style="padding:5px;" v-for="(_item,index) in formData.contentArr" :key="index">
                                    <div class="ub ub-ac ub-f1">
                                        <el-form-item
                                            style="width:33%;margin:0 2px"
                                            label=""

                                        >
                                            <!-- :prop="'contentArr.'+ index +'.field'"
                                            :rules="{required: true,message: '请选择字段名称',trigger: 'change'}" -->
                                            <el-select filterable clearable size="small" v-model="_item.field" placeholder="请选择" @change="changeFields(_item.field,_item)">
                                                <el-option v-for="item in columnNames" :key="item.code" :label="item.name" :value="item.code">
                                                </el-option>
                                            </el-select>
                                        </el-form-item>
                                        <div class="connectLine"></div>
                                        <el-form-item
                                            style="width:33%;margin:0 2px"
                                            label=""
                                            label-width="0px"

                                        >
                                            <!-- :prop="'contentArr.'+ index +'.symbol'"
                                            :rules="{required: true,message: '请选择条件',trigger: 'change'}" -->
                                            <el-select clearable size="small" v-model="_item.symbol" placeholder="请选择" @change="change_thirdOption(_item)">
                                                <el-option v-for="item in _item.terms"  :key="item.code" :label="item.name" :value="item.code">
                                                </el-option>
                                            </el-select>
                                        </el-form-item>
                                        <div class="connectLine"></div>
                                        <el-form-item
                                            style="width:33%;margin:0 2px"
                                            label=""
                                            label-width="0px"

                                        >
                                            <!-- :prop="'contentArr.'+ index +'.value'"
                                            :rules="{required: true,message: '请输入内容',trigger: 'blur'}" -->
                                            <el-input
                                                size="small"
                                                placeholder="请输入"
                                                :disabled = "_item.symbol == 9? true :false"
                                                v-model="_item.value"
                                            ></el-input>
                                        </el-form-item>
                                    </div>
                                    <div class="ub ub-ac ub-pj btn-list">
                                        <i class="add-btn el-icon-circle-plus-outline" v-if="index+1 == formData.contentArr.length" @click="addMappings"></i>
                                        <i class="del-btn el-icon-delete-solid" v-if="index !== 0" @click="removeMapping(index)"></i>
                                    </div>
                                </div>
                                <div v-if="formData.contentArr.length === 0" class="empty-array ub ub-ac w100 ub-pc">
                                    暂无数据
                                </div>
                            </div>
                        </div>
                    </div>
                </el-form-item>
            </el-form>
            <div slot="footer">
                <el-button size="small" @click="cancel">取消</el-button>
                <el-button size="small" type="primary" @click="submit">确认</el-button>
            </div>
        </el-dialog>
        <DeleteDialog
            :dialogVisible = deleteDialog
            @delete="handleDelete"
            @cancel="deleteDialog = false">
        </DeleteDialog>
    </div>
</template>

<script>
import {
    public_edit,
    public_del,
    getSymbolList,
    getLogFieldList,
    public_page
} from '@/server/reporting_platform/report_config.js'
import initData from '@/mixins/initData.js'
import {
    opt_string,
    options_others,
    options_other
} from '../config_data.js'
export default {
    name: 'DataType',
    mixins: [initData],
    data() {
        return {
            tableData: [],
            deleteDialog: false,
            deleteId: '',
            addEditDialog: false,
            formLabelWidth: '120px',
            formData: {
                id: '',
                typeName: '',
                type: 1,
                contentArr: []
            },
            terms: [],
            columnNames: [],
            rules: {},
            vm: this
        }
    },
    watch: {
        addEditDialog: {
            handler(newVal, oldVal) {
                if (!newVal) {
                    this.$refs.formData.resetFields()
                    this.formData.contentArr = []
                }
            }
        }
    },
    filters: {
        getCondition(val, vm) {
            if (!val) {
                return ''
            }
            let current = vm.terms.filter(item => item.code === val)
            if (current.length > 0) {
                return current[0].name
            } else {
                return ''
            }
        },
        getName(val, vm) {
            if (!val) {
                return ''
            }
            let current = vm.columnNames.filter(item => item.field === val)
            if (current.length > 0) {
                return current[0].name
            } else {
                return ''
            }
        }
    },
    methods: {
        get_tj(field, columnNames = []) {
            let terms = []
            if (field) {
                let cur = columnNames.filter(item => item.code === field)
                if (cur.length > 0) {
                    terms = cur[0].type == 1 ? opt_string.map(item => {
                        return {
                            code: item.value,
                            name: item.label
                        }
                    }) : options_others.map(item => {
                        return {
                            code: item.value,
                            name: item.label
                        }
                    })
                } else {
                    terms = options_other.map(item => {
                        return {
                            code: item.value,
                            name: item.label
                        }
                    })
                }
            } else {
                terms = options_other.map(item => {
                    return {
                        code: item.value,
                        name: item.label
                    }
                })
            }
            return terms
        },
        change_thirdOption(obj) {
            if (obj.symbol == 9) {
                obj.value = ''
            }
        },
        changeFields(val, obj) {
            let list = this.get_tj(val, this.columnNames)
            obj.symbol = ''
            obj.terms = list
        },
        indexMethod(index) {
            return (this.listQuery.page - 1) * this.listQuery.limit + index + 1
        },
        handleEdit(row) {
            console.log(row, row)
            this.addEditDialog = true
            this.formData.id = row.id
            this.formData.typeName = row.name
            this.formData.type = row.type
            let ruleItems = row.ruleItems.map(item => {
                let list = this.get_tj(item.field, this.columnNames)
                console.log(list, 'list')
                return {
                    field: item.field,
                    symbol: item.symbol ? item.symbol + '' : '',
                    value: item.value,
                    terms: list
                }
            })
            this.formData.contentArr = ruleItems || []
            if (this.formData.contentArr.length == 0) {
                this.formData.contentArr.push({
                    field: '',
                    symbol: '',
                    value: '',
                    terms: []
                })
            }
        },
        handleDel(row) {
            this.deleteDialog = true
            this.deleteId = row.id
        },
        removeMapping(index) {
            this.formData.contentArr.splice(index, 1)
        },
        addMappings() {
            this.formData.contentArr.push({
                field: '',
                symbol: '',
                value: '',
                terms: []
            })
        },
        submit() {
            this.$refs.formData.validate((valid) => {
                if (valid) {
                    this.editMapping()
                } else {
                    console.log('error submit!!')
                    return false
                }
            })
        },
        editMapping() {
            if (this.formData.contentArr.some(item => item.field != '' && (item.symbol == '' || (item.symbol != 9 && item.value == '')))) {
                this.$message({
                    message: '字段/条件/值有一个不为空时，其余两个不能为空',
                    type: 'warning'
                })
                console.log(1)
                return
            }
            if (this.formData.contentArr.some(item => ((item.symbol != '' && item.symbol != 9 && (item.field == '' || item.value == ''))) || (item.symbol == 9 && item.field == ''))) {
                this.$message({
                    message: '条件为空/不为空时，字段不能为空',
                    type: 'warning'
                })
                return
            }
            if (this.formData.contentArr.some(item => item.value != '' && (item.symbol == '' || item.field == ''))) {
                this.$message({
                    message: '字段/条件/值有一个不为空时，其余两个不能为空',
                    type: 'warning'
                })
                console.log(2)
                return
            }
            if (this.formData.contentArr.some(item => item.symbol == 9 && item.field == '')) {
                this.$message({
                    message: '条件为空时，所选字段不能为空',
                    type: 'warning'
                })
                return
            }
            if (this.formData.contentArr.length > 0) {
                this.formData.contentArr = this.formData.contentArr.map(item => {
                    let cur = this.columnNames.filter(e => e.code === item.field)
                    if (cur.length > 0) {
                        item.fieldType = cur[0].type
                    }
                    return item
                })
            }
            let data = {
                queryData: {},
                paramsData: {
                    type: 1,
                    id: this.formData.id,
                    mapping: this.formData.contentArr.length > 0 ? JSON.stringify(this.formData.contentArr) : ''
                }
            }
            public_edit(data).then(res => {
                this.addEditDialog = false
                this.$message({
                    message: '编辑成功',
                    type: 'success'
                })
                setTimeout(() => {
                    this.get_data()
                }, 500)
            })
        },
        cancel() {
            this.addEditDialog = false
        },
        handleDelete() {
            let data = {
                queryData: {},
                paramsData: {
                    id: this.deleteId,
                    type: 1
                }
            }
            public_del(data).then(res => {
                this.deleteDialog = false
                this.$message({
                    message: '删除成功',
                    type: 'success'
                })
                setTimeout(() => {
                    this.get_data()
                }, 500)
            })
        },
        get_symbol() {
            let data = {
                queryData: {},
                paramsData: {}
            }
            this.terms = []
            getSymbolList(data).then(res => {
                this.terms = res.filter(item => item.code != 11)
            })
        },
        get_field() {
            let data = {
                queryData: {},
                paramsData: {}
            }
            this.terms = []
            getLogFieldList(data).then(res => {
                console.log(res, '字段')
                this.columnNames = res
            })
        },
        get_data() {
            this.listLoading = true
            let data = {
                queryData: {
                    page: this.listQuery.page,
                    pageSize: this.listQuery.limit
                },
                paramsData: {
                    type: 1
                }
            }
            public_page(data).then(res => {
                this.listLoading = false
                let tableData = res.records.map(e => {
                    let ruleItems = e.ruleItems ? e.ruleItems : []
                    ruleItems = ruleItems.map(item => {
                        item.isOr = item.fieldCn && item.symbolCn && item.value
                        return item
                    })
                    let obj = {
                        id: e.id,
                        code: e.code,
                        name: e.name,
                        type: e.type,
                        ruleItems: ruleItems
                    }
                    return obj
                })
                this.tableData = tableData.filter(item => item.code != 'S11')
                this.total = res.total
            }).catch(() => {
                this.listLoading = false
            })
        }
    },
    mounted() {
        // this.get_symbol()
        this.get_field()
        this.get_data()
    }
}
</script>

<style lang='scss' scoped>
.rule-area {
    // width: 81.5%;
    // position: relative;
    // left: 120px;
    // top: -30px;
    // background: rgba(0, 0, 0 , .1);
    border-radius: 4px 4px 2px 4px;
    padding: 10px;
    box-sizing: border-box;
    border: 1px solid #ddd;
}
.btn-list{
    margin-left: 10px;
    width: 40px;
}
.add-Btn{
    cursor: pointer;
    text-align: right;
}
.add-btn {
    cursor: pointer;
    text-align: center;
}
.del-btn {
    cursor: pointer;
    text-align: center;
}
.empty-array {
    color: #fff;
    height: 68px;
}
</style>
